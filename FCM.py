# --- Tab 3: AI ç­–ç•¥é¡§å• (è«–æ–‡å¯«ä½œå°ˆç”¨ç‰ˆ) ---
with tab3:
    st.subheader("ğŸ¤– è«–æ–‡å¯«ä½œèˆ‡æ·±åº¦åˆ†æé¡§å•")
    
    # å°è©±è¦–çª—å®¹å™¨
    chat_container = st.container()
    with chat_container:
        for msg in st.session_state.chat_history:
            if msg["role"] == "user":
                st.markdown(f'<div class="chat-user">ğŸ‘¤ <b>æ‚¨ï¼š</b>{msg["content"]}</div>', unsafe_allow_html=True)
            else:
                st.markdown(f'<div class="chat-ai">ğŸ¤– <b>AIï¼š</b>{msg["content"]}</div>', unsafe_allow_html=True)

    user_input = st.text_input("è¼¸å…¥æŒ‡ä»¤ (ä¾‹å¦‚ï¼šå¹«æˆ‘å¯«æˆè«–æ–‡çµè«–ã€è§£é‡‹æ¯ä¸€å€‹æº–å‰‡)", key="chat_input")
    
    if st.button("é€å‡ºæŒ‡ä»¤") and user_input:
        st.session_state.chat_history.append({"role": "user", "content": user_input})
        
        if st.session_state.last_results is None:
            response = "âš ï¸ è«‹å…ˆè‡³ã€Œæ¨¡æ“¬é‹ç®—ã€è·‘å‡ºæ•¸æ“šï¼Œæˆ‘æ‰èƒ½é€²è¡Œå¯«ä½œã€‚"
        else:
            # æº–å‚™æ•¸æ“šè®Šæ•¸
            results = st.session_state.last_results
            steps = results.shape[0]
            concepts = st.session_state.concepts
            initial = results[0]
            final = results[-1]
            growth = final - initial
            matrix = st.session_state.matrix
            
            # æ‰¾å‡ºé—œéµè§’è‰²
            driver_idx = np.argmax(initial)
            driver_name = concepts[driver_idx]
            best_idx = np.argmax(growth)
            best_name = concepts[best_idx]
            
            response = ""

            # =================================================
            # æ¨¡å¼ A: è«–æ–‡çµè«–ç”Ÿæˆæ¨¡å¼ (æœ€é•·ç¯‡)
            # =================================================
            if "è«–æ–‡" in user_input or "çµè«–" in user_input or "å ±å‘Š" in user_input or "1000" in user_input:
                response += "### ğŸ“ ç¬¬äº”ç« ï¼šçµè«–èˆ‡å»ºè­° (Draft)\n\n"
                response += "ä»¥ä¸‹æ ¹æ“š FCM å‹•æ…‹æ¨¡æ“¬çµæœï¼Œç‚ºæ‚¨æ“¬å®šä¹‹è«–æ–‡çµè«–è‰ç¨¿ï¼Œæ¶µè“‹ç ”ç©¶ç™¼ç¾ã€ç®¡ç†æ„æ¶µèˆ‡å­¸è¡“è²¢ç»ï¼š\n\n"
                
                response += "#### 5.1 ç ”ç©¶çµè«– (Research Findings)\n"
                response += f"æœ¬ç ”ç©¶é‹ç”¨æ¨¡ç³ŠèªçŸ¥åœ– (FCM) æ¨¡æ“¬è£½é€ æ¥­ ESG ç­–ç•¥ä¹‹å‹•æ…‹æ¼”åŒ–éç¨‹ã€‚æ¨¡æ“¬çµæœé¡¯ç¤ºï¼Œç•¶ä¼æ¥­å°‡è³‡æºé›†ä¸­æŠ•å…¥æ–¼ **{driver_name}** (åˆå§‹æŠ•å…¥={initial[driver_idx]:.1f}) æ™‚ï¼Œç³»çµ±å‘ˆç¾é¡¯è‘—çš„éç·šæ€§æˆé•·ç‰¹å¾µã€‚\n\n"
                response += f"å…·é«”è€Œè¨€ï¼Œç¶“é {steps} å€‹ç–Šä»£é€±æœŸçš„æ¼”åŒ–ï¼Œæ•´é«”ç³»çµ±é”æˆå‹•æ…‹æ”¶æ–‚ã€‚æ•¸æ“šæŒ‡å‡ºï¼Œ**{best_name}** ç‚ºæ­¤ç­–ç•¥è·¯å¾‘ä¸‹çš„æœ€å¤§å—æƒ è€…ï¼Œå…¶æ•¸å€¼æˆé•·å¹…åº¦é” **{growth[best_idx]:.2f}** (ç”± {initial[best_idx]:.2f} æå‡è‡³ {final[best_idx]:.2f})ã€‚æ­¤çµæœè­‰å¯¦äº† {driver_name} èˆ‡ {best_name} ä¹‹é–“å­˜åœ¨å¼·çƒˆçš„æ­£å‘å› æœéˆçµï¼Œä¸”è©²éˆçµå…·æœ‰è·¨æ§‹é¢çš„å¤–æº¢æ•ˆæ‡‰ (Spillover Effect)ã€‚\n\n"
                
                response += "#### 5.2 ç®¡ç†æ„æ¶µ (Managerial Implications)\n"
                response += "**ç¬¬ä¸€ï¼Œç¢ºç«‹æ ¸å¿ƒé©…å‹•å› å­çš„æ§“æ¡¿æ•ˆæ‡‰ã€‚**\n"
                response += f"å°æ–¼è³‡æºæœ‰é™çš„ä¼æ¥­è€Œè¨€ï¼Œå…¨é¢æ’’ç¶²å¼çš„ ESG æŠ•è³‡å¾€å¾€æˆæ•ˆä¸å½°ã€‚æœ¬ç ”ç©¶æ¨¡æ“¬è­‰å¯¦ï¼Œ**{driver_name}** å…·å‚™é«˜åº¦çš„ä¸­å¿ƒæ€§ (Centrality)ï¼Œæ˜¯å•Ÿå‹•çµ„ç¹”è®Šé©çš„é—œéµæ§“æ¡¿é»ã€‚ç®¡ç†è€…æ‡‰å„ªå…ˆå¼·åŒ–æ­¤æ§‹é¢ï¼Œåˆ©ç”¨å…¶å°å…¶ä»–æŒ‡æ¨™ï¼ˆå¦‚ {best_name}ï¼‰çš„å¸¶å‹•ä½œç”¨ï¼Œé”æˆã€Œå››å…©æ’¥åƒæ–¤ã€çš„ç­–ç•¥ç¶œæ•ˆã€‚\n\n"
                
                response += "**ç¬¬äºŒï¼Œé‡è¦–ç­–ç•¥ç™¼é…µçš„æ™‚é–“æ»¯å¾Œæ€§ (Time Lag)ã€‚**\n"
                response += f"FCM çš„å‹•æ…‹åœ–å½¢é¡¯ç¤ºï¼Œç­–ç•¥ä»‹å…¥åˆæœŸç³»çµ±åæ‡‰è¼ƒç‚ºå¹³ç·©ï¼Œç›´è‡³ä¸­æœŸæ‰å‡ºç¾æŒ‡æ•¸å‹æˆé•·ã€‚é€™æš—ç¤ºç®¡ç†è€…åœ¨æ¨å‹• ESG è½‰å‹æ™‚ï¼Œéœ€å»ºç«‹ã€Œé•·æœŸä¸»ç¾©ã€çš„è€ƒæ ¸æ€ç¶­ï¼Œå®¹å¿åˆæœŸçš„ä½å›å ±æœŸï¼Œé¿å…å› çŸ­æœŸç¸¾æ•ˆä¸æ˜é¡¯è€Œä¸­æ–·æ­£ç¢ºçš„ç­–ç•¥æ–¹å‘ã€‚\n\n"
                
                response += "#### 5.3 å­¸è¡“ç†è«–è²¢ç» (Theoretical Implications)\n"
                response += "**1. é©—è­‰é«˜éšæ¢¯éšŠç†è«– (Upper Echelons Theory) åœ¨ ESG é ˜åŸŸçš„é©ç”¨æ€§ï¼š**\n"
                response += f"æœ¬ç ”ç©¶é‡åŒ–é©—è­‰äº† Hambrick & Mason (1984) çš„è§€é»ã€‚æ¨¡æ“¬æ•¸æ“šé¡¯ç¤ºï¼Œä»¥ **{driver_name}** (ä»£è¡¨é ˜å°è€…èªçŸ¥/åƒ¹å€¼) ç‚ºèµ·é»çš„ç­–ç•¥ï¼Œèƒ½ç”¢ç”Ÿæœ€ä½³çš„ç³»çµ±æ”¶æ–‚å€¼ã€‚é€™è£œå……äº†éå¾€æ–‡ç»å¤šåé‡å¤–éƒ¨å£“åŠ› (åˆ¶åº¦ç†è«–) çš„ä¸è¶³ï¼Œçªé¡¯äº†å…§éƒ¨èªçŸ¥å› ç´ çš„æ±ºå®šæ€§åœ°ä½ã€‚\n\n"
                
                response += "**2. æ­ç¤º ESG ç¸¾æ•ˆçš„å‹•æ…‹ç”Ÿæˆæ©Ÿåˆ¶ï¼š**\n"
                response += "éå¾€ç ”ç©¶å¤šæ¡éœæ…‹è¿´æ­¸åˆ†æï¼Œé›£ä»¥è§£é‡‹è®Šæ•¸é–“çš„å‹•æ…‹å‚³å°ã€‚æœ¬ç ”ç©¶é€é FCM è¦–è¦ºåŒ–äº†å¾ã€Œæ²»ç†æŠ•å…¥ã€åˆ°ã€Œç¸¾æ•ˆç”¢å‡ºã€çš„é»‘ç›’å­éç¨‹ï¼Œå…·é«”æç¹ªäº†å› æœè·¯å¾‘çš„æ¼”åŒ–è»Œè·¡ï¼Œç‚ºå¾ŒçºŒç ”ç©¶æä¾›äº†æ–°çš„æ–¹æ³•è«–åƒè€ƒã€‚\n"

            # =================================================
            # æ¨¡å¼ B: è©³ç´°è§£é‡‹æ¯ä¸€å€‹æº–å‰‡
            # =================================================
            elif "æ¯ä¸€" in user_input or "è©³ç´°" in user_input or "å…¨éƒ¨" in user_input:
                response += "### ğŸ“‹ å…¨æ–¹ä½æº–å‰‡æ·±åº¦è§£æ\n\n"
                for i, c in enumerate(concepts):
                    g_val = growth[i]
                    f_val = final[i]
                    init_val = initial[i]
                    
                    # åˆ¤æ–·è§’è‰²
                    if init_val > 0.1: role = "ğŸ”´ ç­–ç•¥é©…å‹•è€…"
                    elif g_val > 0.1: role = "ğŸŸ¢ æ ¸å¿ƒå—æƒ è€…"
                    else: role = "ğŸ”µ é€£å‹•å› å­"
                    
                    response += f"**{c}** ({role})\n"
                    response += f"- è®ŠåŒ–ï¼š{init_val:.1f} â†’ {f_val:.2f} (æˆé•· {g_val:+.2f})\n"
                    response += f"- è§£æï¼šæ•¸æ“šé¡¯ç¤ºå…¶åœ¨æ¨¡æ“¬éç¨‹ä¸­å‘ˆç¾{ 'é¡¯è‘—ä¸Šå‡' if g_val>0.1 else 'å¹³ç©©æ³¢å‹•' }ã€‚å»ºè­°åœ¨è«–æ–‡ä¸­{ 'å¼·èª¿å…¶ä½œç‚ºæˆæ•ˆæŒ‡æ¨™çš„é‡è¦æ€§' if g_val>0.1 else 'æ¢è¨å…¶åæ‡‰é²éˆçš„åŸå› ' }ã€‚\n\n"

            # =================================================
            # æ¨¡å¼ C: å›åˆ/éç¨‹åˆ†æ
            # =================================================
            elif "å›åˆ" in user_input or "éç¨‹" in user_input:
                response += "### â³ æ™‚åºéšæ®µåˆ†æ (Time-Series)\n\n"
                response += "**éšæ®µä¸€ï¼šå•Ÿå‹•æœŸ (Step 1-10)**\nç­–ç•¥å‰›ä»‹å…¥ï¼Œåƒ…æœ‰é©…å‹•å› å­æ•¸å€¼ä¸Šå‡ï¼Œç³»çµ±å…§éƒ¨è™•æ–¼æ…£æ€§æŠµæŠ—ç‹€æ…‹ï¼Œç¸¾æ•ˆå°šæœªé¡¯ç¾ã€‚\n\n"
                response += "**éšæ®µäºŒï¼šæ“´æ•£æœŸ (Step 11-25)**\nçŸ©é™£æ•ˆæ‡‰é–‹å§‹ç™¼é…µï¼Œå„é …æŒ‡æ¨™å‘ˆç¾é€£å‹•ä¸Šå‡ï¼Œæ–œç‡æœ€é™¡ï¼Œæ˜¯ç­–ç•¥è½‰å‹çš„é»ƒé‡‘æœŸã€‚\n\n"
                response += "**éšæ®µä¸‰ï¼šç©©å®šæœŸ (Step 26+)**\nç³»çµ±é”åˆ°å‹•æ…‹å¹³è¡¡ï¼Œå½¢æˆæ–°çš„çµ„ç¹”æ–‡åŒ–èˆ‡é‹ä½œå¸¸æ…‹ã€‚\n"

            # =================================================
            # æ¨¡å¼ D: ä¸€èˆ¬å›ç­”
            # =================================================
            else:
                response += f"æ ¹æ“šæ¨¡æ“¬ï¼Œè¡¨ç¾æœ€ä½³çš„æ˜¯ **{best_name}** (å— **{driver_name}** é©…å‹•)ã€‚\n"
                response += "ğŸ’¡ **æç¤º**ï¼šè‹¥éœ€è¦å¯«è«–æ–‡ï¼Œè«‹è¼¸å…¥ã€Œ**å¹«æˆ‘å¯«æˆè«–æ–‡çµè«–**ã€ï¼›è‹¥è¦çœ‹ç´°ç¯€ï¼Œè«‹è¼¸å…¥ã€Œ**è§£é‡‹æ¯ä¸€å€‹æº–å‰‡**ã€ã€‚"

        st.session_state.chat_history.append({"role": "ai", "content": response})
        st.rerun()
