# --- Tab 3: AI ç­–ç•¥é¡§å• (è«–æ–‡å¯«ä½œè¼”åŠ©ç‰ˆ) ---
with tab3:
    st.subheader("ğŸ“ è«–æ–‡æ·±åº¦åˆ†æå ±å‘Šç”Ÿæˆå™¨")
    st.caption("æ­¤åŠŸèƒ½å°‡æ ¹æ“šæ‚¨çš„æ¨¡æ“¬çµæœï¼Œè‡ªå‹•ç”Ÿæˆå…·å‚™ã€Œå­¸è¡“æ„æ¶µã€èˆ‡ã€Œç®¡ç†æ„æ¶µã€çš„åˆ†æè‰ç¨¿ã€‚")
    
    if st.session_state.last_results is None:
        st.warning("âš ï¸ è«‹å…ˆè‡³ã€Œæ¨¡æ“¬é‹ç®—ã€åˆ†é åŸ·è¡Œä¸€æ¬¡æ¨¡æ“¬ï¼Œç³»çµ±æ‰èƒ½å–å¾—æ•¸æ“šé€²è¡Œåˆ†æã€‚")
    else:
        # æº–å‚™æ•¸æ“š
        results = st.session_state.last_results
        final_state = results[-1]
        initial_state = st.session_state.last_initial
        concepts = st.session_state.concepts
        matrix = st.session_state.matrix
        steps = results.shape[0]
        
        # æ‰¾å‡ºé—œéµæ•¸æ“š
        # 1. é©…å‹•å› å­ (Driver): åˆå§‹æŠ•å…¥æœ€é«˜ï¼Œä¸”å¸¶å‹•æ•ˆæœæœ€å¥½çš„
        driver_idx = np.argmax(initial_state) if np.sum(initial_state) > 0 else -1
        driver_name = concepts[driver_idx] if driver_idx != -1 else "ç„¡ç‰¹å®šé©…å‹•å› å­"
        
        # 2. å—ç›Šå› å­ (Receiver): æˆé•·å¹…åº¦æœ€å¤§çš„ (æ’é™¤åŸæœ¬å°±æœ‰æŠ•å…¥çš„)
        growth = final_state - initial_state
        # ç°¡å–®éæ¿¾ï¼šåªçœ‹é‚£äº›åˆå§‹å€¼è¼ƒä½ä½†æˆé•·é«˜çš„
        real_growth = np.where(initial_state < 0.5, growth, 0)
        best_receiver_idx = np.argmax(real_growth)
        best_receiver_name = concepts[best_receiver_idx]
        
        # 3. ç³»çµ±æ”¶æ–‚é€Ÿåº¦ (Stability)
        # è¨ˆç®—ä½•æ™‚é”åˆ°ç©©å®š (è®Šç•°å°æ–¼é–¾å€¼)
        convergence_step = steps
        for t in range(1, steps):
            if np.max(np.abs(results[t] - results[t-1])) < 0.001:
                convergence_step = t
                break
        
        # === é¡¯ç¤ºåˆ†æå€å¡Š ===
        
        st.markdown("### ğŸ“ ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•¸æ“šçµæœæè¿° (Results)")
        st.info(f"""
        **æ¨¡æ“¬çµæœé¡¯ç¤ºï¼š**
        åœ¨æ­¤æƒ…å¢ƒä¸‹ï¼Œæˆ‘å€‘å°‡ **ã€Œ{driver_name}ã€** è¨­å®šç‚ºä¸»è¦ç­–ç•¥ä»‹å…¥é»ï¼ˆåˆå§‹å€¼={initial_state[driver_idx]:.1f}ï¼‰ã€‚
        ç³»çµ±ç¶“é **{convergence_step}** å€‹ç–Šä»£é€±æœŸå¾Œé”åˆ°å‹•æ…‹å¹³è¡¡ã€‚
        
        å…¶ä¸­ï¼Œ**ã€Œ{best_receiver_name}ã€** å±•ç¾äº†æœ€é¡¯è‘—çš„æˆé•·å¹…åº¦ï¼ˆ+{real_growth[best_receiver_idx]:.2f}ï¼‰ï¼Œ
        é¡¯ç¤ºå…¶ç‚ºè©²ç­–ç•¥è·¯å¾‘ä¸‹æœ€ä¸»è¦çš„å—æƒ æ§‹é¢ã€‚
        """)

        st.markdown("### ğŸ“ ç¬¬äºŒéƒ¨åˆ†ï¼šå­¸è¡“èˆ‡ç®¡ç†æ„æ¶µ (Implications)")
        
        col_academic, col_manage = st.columns(2)
        
        with col_academic:
            st.success("#### ğŸ›ï¸ å­¸è¡“æ„æ¶µ (Theoretical Implications)")
            
            # æ ¹æ“šæ•¸æ“šå‹•æ…‹ç”Ÿæˆæ–‡æ¡ˆ
            academic_text = f"""
            **1. é©—è­‰é©…å‹•å› å­çš„å› æœå‚³å°ï¼š**
            æœ¬ç ”ç©¶é€é FCM æ¨¡æ“¬è­‰å¯¦ï¼Œ**{driver_name}** åœ¨ç³»çµ±ä¸­æ‰®æ¼”é—œéµçš„ã€Œé©…å‹•è®Šæ•¸ (Driving Concept)ã€è§’è‰²ã€‚å…¶æ•¸å€¼çš„æå‡ä¸¦éç¨ç«‹äº‹ä»¶ï¼Œè€Œæ˜¯é€éçŸ©é™£ä¸­çš„æ­£å‘è·¯å¾‘ï¼Œé¡¯è‘—æ‹‰æŠ¬äº† **{best_receiver_name}** çš„è¡¨ç¾ã€‚æ­¤çµæœé‡åŒ–æ”¯æŒäº†æ–‡ç»ä¸­é—œæ–¼ã€Œ{driver_name} ç‚º ESG æ ¸å¿ƒåŸºç¤ã€çš„ç†è«–å‡è¨­ã€‚

            **2. ç³»çµ±å‹•æ…‹ç©©å®šæ€§åˆ†æï¼š**
            æ¨¡æ“¬åœ–å½¢é¡¯ç¤ºç³»çµ±åœ¨ç¬¬ {convergence_step} æ­¥å¾Œè¶¨æ–¼æ”¶æ–‚ï¼Œé€™éš±å«äº†çµ„ç¹”å…§éƒ¨çš„ ESG æ²»ç†æ©Ÿåˆ¶å…·æœ‰ã€Œè‡ªçµ„ç¹” (Self-organization)ã€çš„ç‰¹æ€§ã€‚ä¸€æ—¦ç­–ç•¥å•Ÿå‹•ä¸¦åº¦éåˆæœŸçš„éœ‡ç›ªæœŸï¼Œç³»çµ±å°‡å½¢æˆæ–°çš„ç©©æ…‹ï¼Œé€™è§£é‡‹äº†ç‚ºä½•æŒçºŒæ€§çš„æ²»ç†æŠ•å…¥èƒ½å‰µé€ é•·æœŸçš„ç¸¾æ•ˆé–å®šæ•ˆæ‡‰ã€‚
            """
            st.markdown(academic_text)
            st.button("è¤‡è£½å­¸è¡“æ„æ¶µæ–‡å­—", on_click=lambda: st.write("è«‹æ‰‹å‹•è¤‡è£½ä¸Šæ–¹æ–‡å­—"))

        with col_manage:
            st.warning("#### ğŸ’¼ ç®¡ç†æ„æ¶µ (Managerial Implications)")
            
            # æ ¹æ“šæ•¸æ“šå‹•æ…‹ç”Ÿæˆæ–‡æ¡ˆ
            manage_text = f"""
            **1. è³‡æºé…ç½®çš„æœ€ä½³åŒ–ç­–ç•¥ï¼š**
            å°æ–¼ç®¡ç†è€…è€Œè¨€ï¼Œæ¨¡æ“¬çµæœæ­ç¤ºäº†ã€Œé‡è³ªä¸é‡é‡ã€çš„æ±ºç­–é‚è¼¯ã€‚èˆ‡å…¶åˆ†æ•£è³‡æºï¼Œä¸å¦‚é›†ä¸­ç«åŠ›å¼·åŒ– **{driver_name}**ã€‚æ•¸æ“šé¡¯ç¤ºï¼Œåƒ…éœ€å–®é»çªç ´è©²æº–å‰‡ï¼Œå³å¯é€éå¤–æº¢æ•ˆæœ (Spillover Effect) å¸¶å‹• **{best_receiver_name}** ç­‰ä¸‹æ¸¸æŒ‡æ¨™çš„æˆé•·ï¼Œé€™æ˜¯æœ€å…·æˆæœ¬æ•ˆç›Šçš„æ§“æ¡¿ç­–ç•¥ã€‚

            **2. é æœŸæˆæ•ˆçš„æ™‚é–“æ»¯å¾Œç®¡ç†ï¼š**
            ç”±æ–¼ç³»çµ±éœ€ç¶“æ­· {convergence_step} å€‹é€±æœŸæ‰é”åˆ°æœ€å¤§æ•ˆç›Šï¼Œç®¡ç†è€…åœ¨æ¨å‹•ç›¸é—œæ”¿ç­–æ™‚ï¼ˆä¾‹å¦‚å°å…¥ {driver_name}ï¼‰ï¼Œä¸æ‡‰æœŸå¾…ç«‹ç«¿è¦‹å½±ã€‚æ‡‰å°‡ KPI çš„è€ƒæ ¸å€é–“æ‹‰é•·ï¼Œçµ¦äºˆçµ„ç¹”è¶³å¤ çš„æ¶ˆåŒ–èˆ‡å‚³å°æ™‚é–“ï¼Œé¿å…å› çŸ­æœŸç¸¾æ•ˆä¸æ˜é¡¯è€ŒéŒ¯èª¤çµ‚æ­¢æ­£ç¢ºçš„ç­–ç•¥ã€‚
            """
            st.markdown(manage_text)

        st.markdown("---")
        st.markdown("### ğŸ¤– é‚„æ˜¯æœ‰å•é¡Œï¼Ÿç›´æ¥å•æˆ‘ (AI Consultant)")
        user_q = st.text_input("è¼¸å…¥å…·é«”å•é¡Œï¼Œä¾‹å¦‚ï¼šç‚ºä»€éº¼ç’°å¢ƒè²¬ä»»(C2)éƒ½æ²’æœ‰å‹•ï¼Ÿ")
        
        if user_q:
            # ç°¡å–®çš„è¦å‰‡å›æ‡‰é‚è¼¯ (Rule-based Response)
            concept_found = [c for c in concepts if c in user_q]
            
            st.markdown("#### ğŸ’¬ åˆ†æå›ç­”ï¼š")
            if "æ²’å‹•" in user_q or "ä½" in user_q:
                target = concept_found[0] if concept_found else "è©²æŒ‡æ¨™"
                st.write(f"**è¨ºæ–·ï¼š** {target} çš„æ•¸å€¼åä½ï¼Œé€™åœ¨ FCM ç†è«–ä¸­é€šå¸¸ä»£è¡¨ç¼ºä¹ã€Œå…¥åº¦ (In-degree)ã€ã€‚")
                st.write(f"**è§£é‡‹ï¼š** ä¹Ÿå°±æ˜¯èªªï¼Œç›®å‰çš„çŸ©é™£è¨­å®šä¸­ï¼Œæ²’æœ‰è¶³å¤ å¼·å¤§çš„å…¶ä»–å› å­å»ã€Œæ¨å‹•ã€å®ƒã€‚")
                st.write(f"**å»ºè­°ï¼š** è‹¥å¸Œæœ›æå‡ {target}ï¼Œæ‚¨ä¸æ‡‰è©²ç›´æ¥å¼·æ‹‰å®ƒçš„æ•¸å€¼ï¼ˆé‚£æ˜¯æ²»æ¨™ï¼‰ï¼Œè€Œæ˜¯æ‡‰è©²å›åˆ°ã€ŒçŸ©é™£è¦–åœ–ã€ï¼Œå¢åŠ å…¶ä»–æº–å‰‡å° {target} çš„æ¬Šé‡ï¼ˆä¾‹å¦‚è®“ A2 æ›´å¼·çƒˆåœ°å½±éŸ¿ {target}ï¼‰ã€‚é€™åœ¨ç®¡ç†ä¸Šä»£è¡¨ã€Œå»ºç«‹è·¨éƒ¨é–€çš„å”ä½œæ©Ÿåˆ¶ã€ã€‚")
            
            elif "ç­–ç•¥" in user_q:
                st.write(f"**åˆ†æï¼š** å¾æ¨¡æ“¬åœ–ä¾†çœ‹ï¼Œæœ€å…·å„ªå‹¢çš„ç­–ç•¥æ˜¯æŠ•å…¥ **{driver_name}**ã€‚")
                st.write("**å­¸è¡“è§£é‡‹ï¼š** é€™ç¬¦åˆã€Œå·´èŠå¤šæ³•å‰‡ (80/20æ³•å‰‡)ã€ï¼Œå°‘æ•¸çš„é—œéµè®Šæ•¸æ±ºå®šäº†æ•´é«”çš„ç³»çµ±è¡Œç‚ºã€‚å»ºè­°è«–æ–‡ä¸­å¯å¼·èª¿æ­¤ç™¼ç¾ã€‚")
            
            else:
                st.write(f"é€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„åˆ‡å…¥é»ã€‚æ‚¨å¯ä»¥è§€å¯Ÿæ¨¡æ“¬åœ–ä¸­ï¼Œç·šæ¢æ–œç‡æœ€é™¡å³­çš„æ™‚é–“æ®µï¼Œé‚£ä»£è¡¨äº†ç­–ç•¥ç™¼é…µçš„ã€Œé»ƒé‡‘è¦–çª—æœŸã€ã€‚åœ¨è«–æ–‡ä¸­ï¼Œæ‚¨å¯ä»¥æ¢è¨å¦‚ä½•ç¸®çŸ­é€™æ®µåæ‡‰æ™‚é–“ï¼ˆä¾‹å¦‚é€éæ•¸ä½åŒ–å·¥å…·åŠ é€Ÿè³‡è¨Šå‚³éï¼‰ã€‚")
